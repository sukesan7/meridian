name: CI

on:
    push:
        branches: ["main"]
    pull_request:
        branches: ["main"]

permissions:
    contents: read

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    build-and-test:
        name: Build & Test (Python ${{ matrix.python-version }})
        runs-on: ubuntu-latest
        timeout-minutes: 10
        strategy:
            fail-fast: false
            matrix:
                python-version: ["3.11"]

        steps:
            - uses: actions/checkout@v4

            - name: Set up Python ${{ matrix.python-version }}
              uses: actions/setup-python@v5
              with:
                  python-version: ${{ matrix.python-version }}
                  cache: "pip"

            - name: Install Dependencies
              run: |
                  python -m pip install --upgrade pip setuptools wheel build
                  # Install project in editable mode with dev deps
                  pip install -e ".[dev]" --no-build-isolation

            - name: Enforce Code Style (Pre-commit)
              run: |
                  # Runs Black, Ruff, and other hooks defined in .pre-commit-config.yaml
                  pre-commit run --all-files --show-diff-on-failure

            - name: Static Type Check (Mypy)
              run: |
                  # Strict typing check - crucial for Quant/C++ backgrounds
                  mypy s3a_backtester tests

            - name: Run Tests with Coverage
              run: |
                  # -v for verbose logs (easier debugging)
                  # --cov for coverage report
                  # --cov-report=term-missing shows exactly which lines are untested
                  pytest -v --cov=s3a_backtester --cov-report=term-missing

            - name: Verify Package Build
              run: |
                  # Ensures the project can actually be built into a wheel (packaging check)
                  python -m build
