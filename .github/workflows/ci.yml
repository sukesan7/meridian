name: Meridian CI

on:
    push:
        branches: ["main"]
        tags: ["v*"]
    pull_request:
        branches: ["main"]

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    # --- JOB 1: Code Quality & Unit Tests ---
    quality-gate:
        name: Quality & Tests (Python ${{ matrix.python-version }})
        runs-on: ubuntu-latest
        strategy:
            fail-fast: false
            matrix:
                python-version: ["3.10", "3.11"]

        steps:
            - uses: actions/checkout@v4

            - name: Set up Python ${{ matrix.python-version }}
              uses: actions/setup-python@v5
              with:
                  python-version: ${{ matrix.python-version }}
                  cache: "pip"

            - name: Install Dependencies
              run: |
                  python -m pip install --upgrade pip
                  # Install package + dev tools (ruff, mypy, pytest) from pyproject.toml
                  # ".[dev]" means: install current dir (.) + the [dev] extras
                  pip install --no-build-isolation ".[dev]"

            - name: Enforce Code Style (Ruff)
              run: |
                  ruff check .
                  ruff format --check .

            - name: Static Type Check (Mypy)
              run: |
                  mypy s3a_backtester tests

            - name: Run Unit Tests
              run: |
                  pytest -v --cov=s3a_backtester --cov-report=term-missing tests/

    # --- JOB 2: The Determinism Gate ---
    determinism-check:
        name: Determinism Verification
        runs-on: ubuntu-latest
        needs: quality-gate
        steps:
            - uses: actions/checkout@v4

            - name: Set up Python 3.11
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"

            - name: Install Dependencies
              run: |
                  python -m pip install --upgrade pip
                  # Install package + dev tools (needed for verification scripts)
                  pip install --no-build-isolation ".[dev]"

            - name: Generate Synthetic Data
              run: |
                  python -c "
                  import pandas as pd
                  import numpy as np
                  dates = pd.date_range('2024-01-01', '2024-01-05', freq='1min', tz='America/New_York')
                  np.random.seed(42)
                  # Random walk price generation
                  prices = 100 + np.random.randn(len(dates)).cumsum()
                  df = pd.DataFrame({
                      'open': prices,
                      'high': prices + 1,
                      'low': prices - 1,
                      'close': prices,
                      'volume': 1000
                  }, index=dates)
                  df.index.name = 'datetime'
                  df.to_csv('ci_data.csv')
                  "

            - name: Run Backtest A (Reference)
              run: |
                  meridian-run backtest \
                    --config configs/base.yaml \
                    --data ci_data.csv \
                    --out-dir ci_artifacts \
                    --run-id run_A \
                    --seed 12345

            - name: Run Backtest B (Replication)
              run: |
                  meridian-run backtest \
                    --config configs/base.yaml \
                    --data ci_data.csv \
                    --out-dir ci_artifacts \
                    --run-id run_B \
                    --seed 12345

            - name: Verify Bit-Perfect Identity
              run: |
                  python scripts/debug_tools/verify_determinism.py \
                    ci_artifacts/run_A/trades.parquet \
                    ci_artifacts/run_B/trades.parquet
